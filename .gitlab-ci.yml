image: maven:3.3.9-jdk-8

variables:
  MAVEN_OPTS: -Dmaven.repo.local=/cache/maven.repository

stages:
  - compile
  - tests
  - package
  - release

Compile source:
  stage: compile
  script:
    - mvn compile
  when: manual

Unit tests:
  stage: tests
  script:
    - mvn test
  when: manual

Build bundle:
  stage: package
  script: "mvn package -Dmaven.test.skip=true"
  when: manual

Snapshot develop:
  stage: release
  script: "mvn deploy -Dartifactory.username=$AF_API_USR -Dartifactory.password=$AF_API_TKN -Dmaven.test.skip=true"
  only:
    - develop
  when: manual

Snapshot preprod:
  stage: release
  script:
    - oldArtifactId=$(sed -n "/<version>/p" pom.xml | head -1 | sed 's/<version>//g' | sed 's/<\/version>//g' | sed 's/[[:blank:]]//g')
    - if [[ $oldArtifactId == *"SNAPSHOT"* ]]; then mvn deploy -Dartifactory.username=$AF_API_USR -Dartifactory.password=$AF_API_TKN -Dmaven.test.skip=true; fi
  only:
    - preprod

Release:
  stage: release
  script: "mvn deploy -Dartifactory.username=$AF_API_USR -Dartifactory.password=$AF_API_TKN -Dmaven.test.skip=true"
  only:
    - tags
  when: manual
